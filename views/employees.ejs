<!DOCTYPE html>
<html>
<head>
  <title>Employee Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

  <h1 class="mb-4">Employees</h1>

  <!-- Filters -->
  <form method="GET" action="/employees" class="row g-2 mb-3">
    <div class="col-md-4">
      <input type="text" name="search" class="form-control" placeholder="Search by name/email"
             value="<%= filters.search %>">
    </div>
    <div class="col-md-3">
      <select name="department" class="form-select">
        <option value="">All Departments</option>
        <% departments.forEach(d => { %>
          <option value="<%= d._id %>" <%= filters.department == d._id ? 'selected' : '' %>>
            <%= d.name %>
          </option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <input type="text" name="jobTitle" class="form-control" placeholder="Filter by job title"
             value="<%= filters.jobTitle %>">
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>
  </form>

  <!-- Add Employee Form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h4 class="card-title">Add Employee</h4>
      <form action="/employees" method="POST" class="row g-2">
        <div class="col-md-3">
          <input type="text" name="name" class="form-control" placeholder="Name" required>
        </div>
        <div class="col-md-3">
          <input type="email" name="email" class="form-control" placeholder="Email" required>
        </div>
        <div class="col-md-2">
          <input type="text" name="position" class="form-control" placeholder="Job Title" required>
        </div>
        <div class="col-md-2">
          <select name="department" class="form-select" required>
            <option value="">Select Department</option>
            <% departments.forEach(d => { %>
              <option value="<%= d._id %>"><%= d.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-2">
          <select name="supervisor" class="form-select">
            <option value="">-- No Supervisor --</option>
            <% employees.forEach(s => { %>
              <option value="<%= s._id %>"><%= s.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success">Add Employee</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Employee Table -->
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Position</th>
        <th>Department</th>
        <th>Supervisor</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% employees.forEach(emp => { %>
        <tr>
          <!-- Update form inside table row -->
          <form action="/employees/<%= emp._id %>?_method=PUT" method="POST">
            <td>
              <input type="text" name="name" value="<%= emp.name %>" class="form-control" required>
            </td>
            <td>
              <input type="email" name="email" value="<%= emp.email %>" class="form-control" required>
            </td>
            <td>
              <input type="text" name="position" value="<%= emp.position %>" class="form-control" required>
            </td>
            <td>
              <select name="department" class="form-select" required>
                <% departments.forEach(d => { %>
                  <option value="<%= d._id %>" <%= emp.department && emp.department._id.toString() === d._id.toString() ? 'selected' : '' %>>
                    <%= d.name %>
                  </option>
                <% }) %>
              </select>
            </td>
            <td>
              <select name="supervisor" class="form-select">
                <option value="">-- No Supervisor --</option>
                <% employees.forEach(s => { %>
                  <option value="<%= s._id %>" <%= emp.supervisor && emp.supervisor._id.toString() === s._id.toString() ? 'selected' : '' %>>
                    <%= s.name %>
                  </option>
                <% }) %>
              </select>
            </td>
            <td>
              <button type="submit" class="btn btn-sm btn-warning">Update</button>
          </form>
          <!-- Delete -->
          <form action="/employees/<%= emp._id %>?_method=DELETE" method="POST" class="d-inline">
            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this employee?')">
              Delete
            </button>
          </form>
            </td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <!-- Pagination -->
  <nav>
    <ul class="pagination">
      <li class="page-item <%= pagination.page === 1 ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= pagination.page - 1 %>&search=<%= filters.search %>&department=<%= filters.department %>&jobTitle=<%= filters.jobTitle %>">
          Previous
        </a>
      </li>

      <% for (let p = 1; p <= pagination.pages; p++) { %>
        <li class="page-item <%= pagination.page === p ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= p %>&search=<%= filters.search %>&department=<%= filters.department %>&jobTitle=<%= filters.jobTitle %>">
            <%= p %>
          </a>
        </li>
      <% } %>

      <li class="page-item <%= pagination.page === pagination.pages ? 'disabled' : '' %>">
        <a class="page-link" href="?page=<%= pagination.page + 1 %>&search=<%= filters.search %>&department=<%= filters.department %>&jobTitle=<%= filters.jobTitle %>">
          Next
        </a>
      </li>
    </ul>
  </nav>

</body>
</html>
